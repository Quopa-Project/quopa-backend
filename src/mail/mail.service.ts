import {Injectable, InternalServerErrorException} from "@nestjs/common";
import {Resend} from "resend";

@Injectable()
export class MailService {
  private resend: Resend;

  constructor() {
    this.resend = new Resend(process.env.RESEND_API_KEY);
  }

  sendAccountVerificationEmail(to: string, validationToken: string) {
    const url = `${process.env.FRONT_DOMAIN}/account-verification/${validationToken}`;

    const html =
      '<p>Hola,</p>' +
      '<p>Gracias por registrarte en Quopa. Para activar tu cuenta, haz clic en el siguiente botón:</p>' +
      '<div style="margin: 24px 0;">' +
      '<a style="background: #2fc332; color: #ffffff; text-decoration: none; padding: 12px 20px; border-radius: 6px; font-weight: 500;" ' +
      'href="' + url + '" target="_blank" rel="noopener noreferrer">Verificar cuenta</a>' +
      '</div>' +
      '<p>Si el botón no funciona, copia y pega este enlace en tu navegador:</p>' +
      '<p>' +
      url +
      '</p>' +
      '<br><br><br>' +
      '<p>Este correo se encuentra desatendido.<p/>' +
      '<p>Saludos desde el equipo de seguridad de Quopa.</p>';

    this.resend.emails.send({
      from: 'account-verification-quopa@socialsinergy.store',
      to: to,
      subject: 'Verificación de cuenta',
      html: html,
    }).catch(() => {
      throw new InternalServerErrorException({
        message: ['Error al enviar el correo electrónico.'],
        error: 'Internal Server Error',
        statusCode: 500
      });
    });
  }

  async sendVerificationCodeEmail(to: string, code: string) {
    const html =
      '<p>Hola,</p>' +
      '<p>Alguien ha solicitado una nueva contraseña para la cuenta asociada a este correo.</p>' +
      '<p>No se ha hecho ningun cambio aún.</p>' +
      '<p>Si has sido tú, ingresa este código de verificación en la aplicación:</p>' +
      '<p>' +
      code +
      '</p>' +
      '<br><br><br>' +
      '<p>Este correo se encuentra desatendido.<p/>' +
      '<p>Saludos desde el equipo de seguridad de Quopa.</p>';

    const { error } = await this.resend.emails.send({
      from: 'forget-password-qr-kitchen@socialsinergy.store',
      to: to,
      subject: 'Restauración de contraseña',
      html: html,
    });

    if (error) {
      throw new InternalServerErrorException({
        message: ['Error al enviar el correo electrónico.'],
        error: 'Internal Server Error',
        statusCode: 500
      });
    }
  }
}